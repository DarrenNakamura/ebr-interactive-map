<!DOCTYPE html>
<html lang="en-US">
    <!-- The Earthborne Rangers Interactive Map was hand-coded by Darren Nakamura for Earthborne Games. -->

    <head>
        <title>Earthborne Rangers Interactive Maps</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="styles.css">
        <script src="locations.js"></script>
    </head>

    <body>
        <div id="mapDiv">
            <svg width="auto" height="auto" xmlns="http://www.w3.org/2000/svg" id="mapSVG">
                <!-- Render the map -->
                <image id="mapImage" height="4000" width="2829" x="0" y="0" href="ValleyMapOLD.jpg" transform="scale(0.5)" />
                <!-- All of the rest of the rendering happens via script below -->
            </svg>
        </div>

        <script>
            let svgElem = document.getElementById("mapSVG");
            let map = document.getElementById("mapImage");
            let svgWidth, svgHeight;

            // Get the dimensions of the svg element
            function getSvgDimensions() {
                let svgRect = svgElem.getBoundingClientRect();
                svgWidth = Math.round(svgRect["width"]);
                svgHeight = Math.round(svgRect["height"]);
            }

            // Get the current scale factor of the map
            function getScaleFactor() {
                let mapTransform = map.getAttribute("transform");
                let mapScale = mapTransform.replace("scale(", "");
                return Number(mapScale.replace(")", ""));
            }

            // This function allows the user to move the map
            // within the svg element by clicking and dragging it
            mapSVG.onmousedown = function(event) {
                // Get the starting coordinates of the cursor
                let cursorStartX = event.clientX;
                let cursorStartY = event.clientY;

                // Get the starting origin coordinates and scaling of the map image
                let mapOriginX = Number(map.getAttribute("x"));
                let mapOriginY = Number(map.getAttribute("y"));
                let scaleFactor = getScaleFactor();

                // Modify the image coordinates using math
                document.addEventListener("mousemove", onMouseMove);
                function onMouseMove(event) {
                    // Get the new coordinates of the cursor
                    let cursorCurrentX = event.clientX;
                    let cursorCurrentY = event.clientY;

                    // Calculate movement
                    let deltaX = Math.round((cursorCurrentX - cursorStartX) / scaleFactor);
                    let deltaY = Math.round((cursorCurrentY - cursorStartY) / scaleFactor);

                    // Update map origin
                    mapOriginX += deltaX;
                    mapOriginY += deltaY;

                    // Update map position
                    map.setAttribute("x", mapOriginX.toString());
                    map.setAttribute("y", mapOriginY.toString());

                    // Update starting cursor position
                    cursorStartX = cursorCurrentX;
                    cursorStartY = cursorCurrentY;
                }

                // Stop listening to the cursor when the user unclicks anywhere
                document.onmouseup = function() {
                    document.removeEventListener("mousemove", onMouseMove);
                    updateLocationButtons();
                };
            };

            // These functions allow the user to zoom in and out
            function zoomIn() {
                getSvgDimensions();
                let mapOriginX = Number(map.getAttribute("x"));
                let mapOriginY = Number(map.getAttribute("y"));
                let scaleFactor = getScaleFactor();
                let maximumScaleFactor = 1.0;

                // Limit zooming in to a certain point
                if (scaleFactor < maximumScaleFactor) {
                    // First, change the scale factor
                    scaleFactor += 0.1;
                    let scaleString = "scale(" + String(scaleFactor) + ")";
                    map.setAttribute("transform", scaleString);

                    // Next, move the origin to scale from the center instead of the origin
                    let newMapOriginX = mapOriginX + Math.round((svgWidth * (scaleFactor - 1.0) / 2.0));
                    let newMapOriginY = mapOriginY + Math.round((svgHeight * (scaleFactor - 1.0) / 2.0));
                    map.setAttribute("x", newMapOriginX.toString());
                    map.setAttribute("y", newMapOriginY.toString());

                    // Update location buttons
                    updateLocationButtons();
                }
            }
            function zoomOut() {
                getSvgDimensions();
                let mapOriginX = Number(map.getAttribute("x"));
                let mapOriginY = Number(map.getAttribute("y"));
                let scaleFactor = getScaleFactor();
                let minimumScaleFactor = 0.3;

                // Limit zooming out to a certain point
                if (scaleFactor > minimumScaleFactor) {
                    // First, change the scale factor
                    scaleFactor -= 0.1;
                    let scaleString = "scale(" + String(scaleFactor) + ")";
                    map.setAttribute("transform", scaleString);

                    // Next, move the origin to scale from the center instead of the origin
                    let newMapOriginX = mapOriginX - Math.round((svgWidth * (scaleFactor - 1.0) / 2.0));
                    let newMapOriginY = mapOriginY - Math.round((svgHeight * (scaleFactor - 1.0) / 2.0));
                    map.setAttribute("x", newMapOriginX.toString());
                    map.setAttribute("y", newMapOriginY.toString());

                    // Update location buttons
                    updateLocationButtons();
                }
            }

            // This function should allow an administrator to create
            // links for locations, given the location's coordinates on the map,
            // the type of location, and the page it should link to
            function createLocationButton(locationX, locationY, isPivotal, locationLink) {
                let scaleFactor = getScaleFactor();
                let svg = document.getElementById("mapSVG");

                // Calculate center of location based on zoom factor
                let scaledX = Math.round(locationX * scaleFactor);
                let scaledY = Math.round(locationY * scaleFactor);

                // Create the link that this button will go to
                let newLink = document.createElementNS("http://www.w3.org/2000/svg", "a");
                let linkStr = "createLivingValleyPopUp('" + locationLink + "')";
                newLink.setAttribute("href", "javascript:null");
                newLink.setAttribute("onclick", linkStr);
                newLink.setAttribute("class", "locationLink");
                svg.appendChild(newLink);

                // If the location is pivotal, make the button a circle
                if (isPivotal) {
                    // Calculate the radius based on zoom factor
                    let standardRadius = 56;
                    let scaledRadius = Math.round(standardRadius * scaleFactor);

                    // Create the circle based on current zoom and window
                    let newCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    newCircle.setAttribute("r", scaledRadius);
                    newCircle.setAttribute("cx", scaledX);
                    newCircle.setAttribute("cy", scaledY);
                    newCircle.setAttribute("class", "locationButton circle");
                    newCircle.setAttribute("data-x", locationX);
                    newCircle.setAttribute("data-y", locationY);
                    newLink.appendChild(newCircle);
                }
                // Otherwise, make it a square rotated 45 degrees
                else {
                    // Find the Y-coordinate for the top of the location
                    let topY = (locationY - 65) * scaleFactor;

                    // Calculate the square's length based on the zoom factor
                    let standardLength = 95;
                    let scaledLength = Math.round(standardLength * scaleFactor);

                    // Create string to control 45 degree rotation about the top of the square
                    let rotateString = "rotate(45 " + scaledX + " " + topY + ")";

                    // Create the square based on the current zoom and window
                    let newSquare = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    newSquare.setAttribute("width", scaledLength);
                    newSquare.setAttribute("height", scaledLength);
                    newSquare.setAttribute("x", scaledX);
                    newSquare.setAttribute("y", topY);
                    newSquare.setAttribute("rx", 6); // rounded corners
                    newSquare.setAttribute("ry", 6); // rounded corners
                    newSquare.setAttribute("transform", rotateString);
                    newSquare.setAttribute("class", "locationButton square");
                    newSquare.setAttribute("data-x", locationX);
                    newSquare.setAttribute("data-y", locationY);
                    newLink.appendChild(newSquare);
                }
            }

            // This function should update the position and scale of the location
            // buttons depending on the panning/zooming of the map
            function updateLocationButtons() {
                // Get current map coordinates and scale factor
                let mapOriginX = Number(map.getAttribute("x"));
                let mapOriginY = Number(map.getAttribute("y"));
                let scaleFactor = getScaleFactor();

                // Iterate over all of the SVG children
                for (const svgChild of svgElem.children) {
                    // Only look at the location links
                    if (svgChild.getAttribute("class") == "locationLink") {
                        for (const linkChild of svgChild.children) {
                            // Update pivotal location button positions
                            if (linkChild.getAttribute("class") == "locationButton circle") {
                                // Calculate
                                let originalX = Number(linkChild.getAttribute("data-x"));
                                let originalY = Number(linkChild.getAttribute("data-y"));
                                let newX = Math.round((originalX + mapOriginX) * scaleFactor);
                                let newY = Math.round((originalY + mapOriginY) * scaleFactor);
                                let standardRadius = 56;
                                let scaledRadius = standardRadius * scaleFactor;

                                // Set attributes
                                linkChild.setAttribute("cx", newX);
                                linkChild.setAttribute("cy", newY);
                                linkChild.setAttribute("r", scaledRadius);
                            }
                            // Update non-pivotal location button positions
                            else if (linkChild.getAttribute("class") == "locationButton square") {
                                // Calculate
                                let originalX = Number(linkChild.getAttribute("data-x"));
                                let originalY = Number(linkChild.getAttribute("data-y"));
                                let newX = Math.round((originalX + mapOriginX) * scaleFactor);
                                let newY = Math.round((originalY + mapOriginY - 65) * scaleFactor);
                                let standardLength = 95;
                                let scaledLength = Math.round(standardLength * scaleFactor);
                                let rotateString = "rotate(45 " + newX + " " + newY + ")";

                                // Set attributes
                                linkChild.setAttribute("width", scaledLength);
                                linkChild.setAttribute("height", scaledLength);
                                linkChild.setAttribute("x", newX);
                                linkChild.setAttribute("y", newY);
                                linkChild.setAttribute("transform", rotateString);
                            }
                        }
                    }
                }
            }

            // Iterate over the location data to create buttons for each location
            for (const location of locationData) {
                let locationX = location["x"];
                let locationY = location["y"];
                let locationIsPivotal = location["isPivotal"];
                let locationURL = location["url"];

                createLocationButton(locationX, locationY, locationIsPivotal, locationURL);
            }

            // Create zoom buttons last so they are on top
            function createZoomButtons() {
                // Get the map SVG to append the zoom button SVG into
                let svg = document.getElementById("mapSVG");

                // Create SVG child that will render zoom buttons
                let zoomButtonSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');

                // Set its starting attributes
                zoomButtonSVG.setAttribute("id", "zoomButtons");
                zoomButtonSVG.setAttribute("width", 50);
                zoomButtonSVG.setAttribute("height", 100);
                zoomButtonSVG.setAttribute("x", 10);
                zoomButtonSVG.setAttribute("y", 10);

                // Append the zoom button SVG to the map SVG
                svg.appendChild(zoomButtonSVG);

                // Fill the zoom button SVG with the elements that make it look like zoom buttons
                // Gray rectangle with rounded corners
                let zoomButtonRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                zoomButtonRect.setAttribute("width", 48);
                zoomButtonRect.setAttribute("height", 98);
                zoomButtonRect.setAttribute("x", 1);
                zoomButtonRect.setAttribute("y", 1);
                zoomButtonRect.setAttribute("rx", 8);
                zoomButtonRect.setAttribute("ry", 8);
                zoomButtonRect.setAttribute("class", "zoomButtonStyle");
                zoomButtonSVG.appendChild(zoomButtonRect);
                // Line separating zoom in and zoom out
                let zoomButtonLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                zoomButtonLine.setAttribute("x1", 1);
                zoomButtonLine.setAttribute("x2", 49);
                zoomButtonLine.setAttribute("y1", 50);
                zoomButtonLine.setAttribute("y2", 50);
                zoomButtonLine.setAttribute("class", "zoomButtonStyle");
                zoomButtonSVG.appendChild(zoomButtonLine);
                // Plus sign
                let zoomButtonPlus = document.createElementNS("http://www.w3.org/2000/svg", "text");
                zoomButtonPlus.setAttribute("x", "50%");
                zoomButtonPlus.setAttribute("y", "27%");
                zoomButtonPlus.setAttribute("class", "zoomButtonText");
                zoomButtonPlus.setAttribute("font-size", 36);
                zoomButtonPlus.textContent = "+";
                zoomButtonSVG.appendChild(zoomButtonPlus);
                // Minus sign
                let zoomButtonMinus = document.createElementNS("http://www.w3.org/2000/svg", "text");
                zoomButtonMinus.setAttribute("x", "50%");
                zoomButtonMinus.setAttribute("y", "77%");
                zoomButtonMinus.setAttribute("class", "zoomButtonText");
                zoomButtonMinus.setAttribute("font-size", 50);
                zoomButtonMinus.textContent = "-";
                zoomButtonSVG.appendChild(zoomButtonMinus);

                // Create the functional button areas that actually respond to clicking
                // Zoom in button
                let zoomInFuncButton = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                zoomInFuncButton.setAttribute("width", 48);
                zoomInFuncButton.setAttribute("height", 48);
                zoomInFuncButton.setAttribute("x", 1);
                zoomInFuncButton.setAttribute("y", 1);
                zoomInFuncButton.setAttribute("rx", 8);
                zoomInFuncButton.setAttribute("ry", 8);
                zoomInFuncButton.setAttribute("class", "zoomButtonFunction");
                zoomInFuncButton.addEventListener("click", zoomIn);
                zoomButtonSVG.appendChild(zoomInFuncButton);
                // Zoom out button
                let zoomOutFuncButton = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                zoomOutFuncButton.setAttribute("width", 48);
                zoomOutFuncButton.setAttribute("height", 48);
                zoomOutFuncButton.setAttribute("x", 1);
                zoomOutFuncButton.setAttribute("y", 51);
                zoomOutFuncButton.setAttribute("rx", 8);
                zoomOutFuncButton.setAttribute("ry", 8);
                zoomOutFuncButton.setAttribute("class", "zoomButtonFunction");
                zoomOutFuncButton.addEventListener("click", zoomOut);
                zoomButtonSVG.appendChild(zoomOutFuncButton);
            }
            createZoomButtons();

            // Place the zoom buttons on the right side
            function placeZoomButtonsOnRight() {
                getSvgDimensions();
                let zoomRect = document.getElementById("zoomButtons");
                let zoomButtonWidth = Number(zoomRect.getAttribute("width"));
                let rightPadding = 10;
                let zoomButtonRightPositioning = svgWidth - rightPadding - zoomButtonWidth;
                zoomButtonRightPositioning = String(zoomButtonRightPositioning);
                zoomRect.setAttribute("x", zoomButtonRightPositioning);
            }
            placeZoomButtonsOnRight();

            // Make sure the zoom buttons stay on the right if window is resized
            window.onresize = function() {
                placeZoomButtonsOnRight();
            };

            // This function will create an iframe with the Living Valley
            // entry corresponding to the location clicked, overlaid on the map
            function createLivingValleyPopUp(locationURL) {
                // If there is already a frame open, we need to destroy it first
                if (document.getElementById("livingValleySVG")) {
                    destroyLivingValleyPopUp();
                }
                
                // Build the pop up that will contain the Living Valley iframe
                // First the SVG to contain all of these things
                let livingValleySVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                livingValleySVG.setAttribute("height", 550);
                livingValleySVG.setAttribute("width", 400);
                livingValleySVG.setAttribute("x", 10);
                livingValleySVG.setAttribute("y", 10);
                livingValleySVG.setAttribute("id", "livingValleySVG");
                svgElem.appendChild(livingValleySVG);

                // First the background rectangle
                let livingValleyBG = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                livingValleyBG.setAttribute("height", 550);
                livingValleyBG.setAttribute("width", 400);
                livingValleyBG.setAttribute("x", 0);
                livingValleyBG.setAttribute("y", 0);
                livingValleyBG.setAttribute("rx", 8);
                livingValleyBG.setAttribute("ry", 8);
                livingValleyBG.setAttribute("class", "livingValleyBG");
                livingValleySVG.appendChild(livingValleyBG);

                // Add the close button's text
                let closeButtonX = document.createElementNS("http://www.w3.org/2000/svg", "text");
                closeButtonX.setAttribute("x", 375);
                closeButtonX.setAttribute("y", 25);
                closeButtonX.setAttribute("class", "closeButtonText");
                closeButtonX.setAttribute("font-size", 36);
                closeButtonX.textContent = "x";
                livingValleySVG.appendChild(closeButtonX);
                // Then the close button function
                let closeButton = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                closeButton.setAttribute("width", 48);
                closeButton.setAttribute("height", 48);
                closeButton.setAttribute("x", 351);
                closeButton.setAttribute("y", 1);
                closeButton.setAttribute("rx", 8);
                closeButton.setAttribute("ry", 8);
                closeButton.setAttribute("class", "closeButtonFunction");
                closeButton.addEventListener("click", destroyLivingValleyPopUp);
                livingValleySVG.appendChild(closeButton);

                let iFrameContainer = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");

                // Set size and position
                iFrameContainer.setAttribute("height", 490);
                iFrameContainer.setAttribute("width", 380);
                iFrameContainer.setAttribute("x", 20);
                iFrameContainer.setAttribute("y", 60);
                iFrameContainer.setAttribute("class", "iFrameContainer");
                iFrameContainer.setAttribute("id", "livingValleyFrame");

                // Create iframe to Living Valley entry
                let livingValleyFrame = document.createElement("iframe");
                let url = "https://thelivingvalley.earthbornegames.com/docs/campaign_guide/" + locationURL;
                livingValleyFrame.src = url;
                livingValleyFrame.width ="100%";
                livingValleyFrame.height ="100%";

                iFrameContainer.appendChild(livingValleyFrame);
                svgElem.appendChild(iFrameContainer);
            }

            // This function will destroy the iframe with the Living Valley
            // entry and its corresponding graphical accompaniments
            function destroyLivingValleyPopUp() {
                // Remove the SVG element holding the graphics
                let svg = document.getElementById("livingValleySVG");
                svg.parentNode.removeChild(svg);

                // Remove the iframe element holding the external website
                let frame = document.getElementById("livingValleyFrame");
                frame.parentNode.removeChild(frame);
            }
        </script>
    </body>

</html>